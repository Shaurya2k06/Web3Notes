# DeFi Derivatives and Perpetual Futures

## Overview

Derivatives are financial contracts whose value derives from an underlying asset. In DeFi, derivatives enable leveraged trading, hedging, and sophisticated financial strategies without traditional intermediaries.

## Types of DeFi Derivatives

### 1. Perpetual Futures (Perps)

Futures contracts without expiration dates.

**Key Features:**
- No settlement date
- Funding rate mechanism
- High leverage (up to 100x)
- Cash-settled

**Funding Rate:**

Mechanism to keep perpetual price anchored to spot:

```
Funding Rate = (Perp Price - Spot Price) / Spot Price × Time Factor
```

**Positive Funding (Perp > Spot):**
- Longs pay shorts
- Incentivizes shorting
- Brings perp price down

**Negative Funding (Perp < Spot):**
- Shorts pay longs
- Incentivizes longing
- Brings perp price up

**Example:**
```
ETH Spot: $2,000
ETH Perp: $2,020
Funding Rate: 0.01% per 8 hours (0.03% daily)

Long position: 10 ETH
Daily funding payment: 10 × $2,020 × 0.0003 = $6.06
Annual cost: $2,212 (if rate stays constant)
```


### dYdX Protocol

Decentralized perpetual exchange:

**Architecture:**
- Layer 2 (StarkEx, now dYdX Chain)
- Order book model
- Cross-margining
- Up to 20x leverage

**Margin Calculation:**
```
Initial Margin = Position Size / Leverage
Maintenance Margin = Position Size × Maintenance Margin Fraction

Example:
Position: $100,000 ETH long
Leverage: 10x
Initial Margin: $10,000
Maintenance Margin: $100,000 × 0.03 = $3,000

Liquidation when equity < $3,000
```

**Liquidation:**
```
Liquidation Price (Long) = Entry Price × (1 - Initial Margin % + Maintenance Margin %)
Liquidation Price (Short) = Entry Price × (1 + Initial Margin % - Maintenance Margin %)

Example Long:
Entry: $2,000
Leverage: 10x (10% initial margin)
Maintenance: 3%

Liquidation = $2,000 × (1 - 0.10 + 0.03) = $1,860
```

### GMX Protocol

Decentralized spot and perpetual exchange:

**GLP Pool:**
- Multi-asset liquidity pool
- Traders trade against the pool
- LPs earn fees + esGMX rewards
- Pool takes opposite side of trades

**Composition:**
```
GLP Pool:
- 50% stablecoins (USDC, USDT, DAI)
- 25% ETH
- 20% WBTC
- 5% other assets

Rebalancing: Dynamic based on trader positions
```

**Pricing:**
```
Uses Chainlink oracles
No price impact on trades
Fees: 0.1% for stables, 0.2% for others
```

**PnL Distribution:**
```
Trader Profit = GLP Loss
Trader Loss = GLP Profit

If traders are net profitable: GLP value decreases
If traders are net losing: GLP value increases
```

### 2. Options

Contracts giving the right (not obligation) to buy/sell at a specific price.

**Call Option:**
- Right to buy asset at strike price
- Profit if price goes up

**Put Option:**
- Right to sell asset at strike price
- Profit if price goes down

**Option Pricing (Black-Scholes):**
```
C = S₀N(d₁) - Ke^(-rT)N(d₂)

Where:
d₁ = [ln(S₀/K) + (r + σ²/2)T] / (σ√T)
d₂ = d₁ - σ√T

S₀ = Current price
K = Strike price
r = Risk-free rate
T = Time to expiration
σ = Volatility
N() = Cumulative normal distribution
```

**Greeks:**

**Delta (Δ):** Price sensitivity
```
Δ = ∂Option Price / ∂Underlying Price
Range: 0 to 1 (calls), -1 to 0 (puts)
```

**Gamma (Γ):** Delta sensitivity
```
Γ = ∂Delta / ∂Underlying Price
Highest at-the-money
```

**Theta (Θ):** Time decay
```
Θ = ∂Option Price / ∂Time
Always negative (options lose value over time)
```

**Vega (ν):** Volatility sensitivity
```
ν = ∂Option Price / ∂Volatility
Higher for at-the-money options
```

**Dopex Protocol:**

Decentralized options exchange:

**Single Staking Option Vaults (SSOVs):**
```
1. Users deposit assets (e.g., ETH)
2. Protocol sells call options on deposits
3. Option buyers pay premiums
4. Depositors earn premiums + rewards
5. If exercised, depositors sell at strike price
```

**Example:**
```
Deposit: 10 ETH @ $2,000
Strike: $2,500 (1 month)
Premium: 5% ($1,000)

Scenario 1 - ETH stays below $2,500:
- Keep 10 ETH + $1,000 premium
- Return: 5% in 1 month

Scenario 2 - ETH goes to $3,000:
- Sell 10 ETH at $2,500 = $25,000
- Plus $1,000 premium = $26,000
- Opportunity cost: $30,000 - $26,000 = $4,000
```

### 3. Synthetic Assets

Tokens tracking the price of real-world assets.

**Synthetix Protocol:**

**Mechanism:**
```
1. Lock SNX as collateral (500% collateralization)
2. Mint synthetic assets (sUSD, sETH, sBTC, etc.)
3. Trade synths on Synthetix Exchange
4. Burn synths to unlock SNX
```

**Debt Pool:**
```
All synth minters share global debt
Debt fluctuates with synth prices

Example:
You mint: $1,000 sUSD (10% of total debt)
Total debt: $10,000

If synth prices increase total debt to $12,000:
Your debt: $1,200 (still 10%)

If synth prices decrease total debt to $8,000:
Your debt: $800
```

**Collateralization Ratio:**
```
C-Ratio = SNX Value / Debt Value

Target: 500%
Liquidation: < 160%

Example:
Lock: $50,000 SNX
Mint: $10,000 sUSD
C-Ratio: 500%

If SNX drops 50%:
SNX Value: $25,000
C-Ratio: 250% (still safe)

If SNX drops 70%:
SNX Value: $15,000
C-Ratio: 150% (liquidation risk)
```

**Mirror Protocol (Terra):**

Synthetic stocks (now defunct):
```
Assets: mAAPL, mTSLA, mGOOG, etc.
Collateral: UST (algorithmic stablecoin)
Minimum Collateral: 150%
```

### 4. Interest Rate Derivatives

**Notional Finance:**

Fixed-rate lending and borrowing:

**fCash Tokens:**
```
Represent claim to future cash flows
Trade at discount to face value

Example:
fUSDC maturing in 6 months
Face value: $1,000
Current price: $970
Implied rate: 6.2% APY
```

**Fixed Rate Calculation:**
```
Fixed Rate = (Face Value / Current Price)^(365/Days) - 1

Example:
Face: $1,000
Price: $970
Days: 180

Rate = ($1,000 / $970)^(365/180) - 1 = 6.4% APY
```

**Pendle Finance:**

Yield tokenization:

**Mechanism:**
```
Split yield-bearing token into:
1. Principal Token (PT): Underlying asset
2. Yield Token (YT): Future yield

Example:
Deposit: 100 aUSDC (earning 5% APY)
Receive: 100 PT-aUSDC + 100 YT-aUSDC

PT-aUSDC: Redeemable for 100 USDC at maturity
YT-aUSDC: Receives all yield until maturity
```

**Use Cases:**
```
Fixed Yield: Buy PT at discount
Yield Speculation: Buy YT if expecting high yields
Hedging: Separate principal from yield risk
```

## Leverage Mechanisms

### Cross Margin vs Isolated Margin

**Isolated Margin:**
```
Each position has separate margin
Liquidation affects only that position
Lower risk of total account liquidation
```

**Cross Margin:**
```
All positions share account balance
Liquidation can affect entire account
More capital efficient
Better for hedged positions
```

**Example:**
```
Account: $10,000

Isolated:
- Position 1: $5,000 margin, $50,000 exposure
- Position 2: $5,000 margin, $50,000 exposure
- If Position 1 liquidated, Position 2 unaffected

Cross:
- Total margin: $10,000
- Position 1: $50,000 exposure
- Position 2: $50,000 exposure
- If one position loses, other's margin can cover
```

### Liquidation Cascades

When mass liquidations trigger more liquidations:

```
1. Market drops 10%
2. Leveraged longs get liquidated
3. Liquidations create sell pressure
4. Market drops another 5%
5. More liquidations triggered
6. Cascade continues
```

**Historical Example (May 2021):**
```
BTC: $58,000 → $30,000 in days
Liquidations: $10 billion+
Leverage: Up to 100x on some platforms
Result: Massive cascade, exchange outages
```

## Advanced Strategies

### 1. Basis Trading

Exploit futures premium:

```
Spot BTC: $40,000
3-month Future: $42,000
Basis: 5% (20% annualized)

Strategy:
1. Buy spot BTC
2. Short BTC future
3. Hold to expiration
4. Profit: $2,000 per BTC

Risk: Funding costs, liquidation
```

### 2. Delta-Neutral Options

Hedge directional risk:

```
Sell 10 ETH call options (Delta: 0.5)
Buy 5 ETH (Delta: 1.0)

Net Delta: (10 × -0.5) + (5 × 1.0) = 0

Profit from:
- Time decay (theta)
- Volatility decrease (vega)
- Premium collection

Rebalance as delta changes
```

### 3. Volatility Arbitrage

Trade implied vs realized volatility:

```
If implied volatility > expected realized volatility:
- Sell options (collect high premium)
- Delta hedge
- Profit from volatility overpricing

If implied volatility < expected realized volatility:
- Buy options (cheap premium)
- Profit from volatility increase
```

### 4. Funding Rate Arbitrage

Exploit perpetual funding rates:

```
Positive Funding (0.1% per 8 hours):
1. Short perpetual
2. Buy spot
3. Collect funding payments
4. Delta-neutral position

Annual Return: 0.1% × 3 × 365 = 109.5% APY
Risks: Basis risk, liquidation, exchange risk
```

## Risk Management

### Position Sizing

**Kelly Criterion:**
```
f* = (bp - q) / b

Where:
f* = Fraction of capital to risk
b = Odds received (reward/risk ratio)
p = Probability of winning
q = Probability of losing (1-p)

Example:
Win rate: 60%
Risk/Reward: 1:2

f* = (2 × 0.6 - 0.4) / 2 = 0.4 (40% of capital)
```

**Practical Application:**
```
Account: $100,000
Kelly: 40%
Conservative (1/4 Kelly): 10%
Position size: $10,000
```

### Stop Losses

**Fixed Percentage:**
```
Entry: $2,000
Stop: 5% below = $1,900
Position: $10,000
Max Loss: $500
```

**ATR-Based:**
```
ATR (14-day): $100
Stop: 2 × ATR = $200 below entry
Entry: $2,000
Stop: $1,800
```

### Liquidation Monitoring

**Health Factor Alerts:**
```
Safe: > 2.0
Warning: 1.5 - 2.0
Critical: 1.0 - 1.5
Liquidation: < 1.0

Set alerts at 1.5 to take action
```

## Code Example: Perpetual Contract

```solidity
contract SimplePerpetual {
    struct Position {
        uint256 size;
        uint256 entryPrice;
        bool isLong;
        uint256 margin;
        uint256 leverage;
    }
    
    mapping(address => Position) public positions;
    uint256 public fundingRate = 10; // 0.01% per hour
    uint256 public lastFundingTime;
    
    function openPosition(
        uint256 margin,
        uint256 leverage,
        bool isLong
    ) external payable {
        require(msg.value == margin, "Incorrect margin");
        require(leverage <= 100, "Max 100x leverage");
        
        uint256 size = margin * leverage;
        uint256 price = getOraclePrice();
        
        positions[msg.sender] = Position({
            size: size,
            entryPrice: price,
            isLong: isLong,
            margin: margin,
            leverage: leverage
        });
    }
    
    function closePosition() external {
        Position memory pos = positions[msg.sender];
        require(pos.size > 0, "No position");
        
        uint256 currentPrice = getOraclePrice();
        int256 pnl = calculatePnL(pos, currentPrice);
        
        uint256 payout = uint256(int256(pos.margin) + pnl);
        delete positions[msg.sender];
        payable(msg.sender).transfer(payout);
    }
    
    function calculatePnL(
        Position memory pos,
        uint256 currentPrice
    ) internal pure returns (int256) {
        int256 priceDiff = int256(currentPrice) - int256(pos.entryPrice);
        if (!pos.isLong) priceDiff = -priceDiff;
        
        return (priceDiff * int256(pos.size)) / int256(pos.entryPrice);
    }
    
    function liquidate(address user) external {
        Position memory pos = positions[user];
        uint256 currentPrice = getOraclePrice();
        int256 pnl = calculatePnL(pos, currentPrice);
        
        // Liquidate if loss exceeds 90% of margin
        require(pnl < -int256(pos.margin * 90 / 100), "Not liquidatable");
        
        delete positions[user];
        // Pay liquidator bonus
    }
    
    function getOraclePrice() internal view returns (uint256) {
        // Integrate with Chainlink or other oracle
        return 2000 * 1e18; // Placeholder
    }
}
```

## Conclusion

DeFi derivatives provide powerful tools for leverage, hedging, and speculation. Understanding their mechanics, risks, and proper risk management is essential for successful trading.

---

*Next: Flash Loans*
