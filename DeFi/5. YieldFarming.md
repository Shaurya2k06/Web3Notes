# Yield Farming and Liquidity Mining

## Overview

Yield farming is the practice of strategically moving crypto assets between DeFi protocols to maximize returns. Liquidity mining specifically refers to earning protocol tokens as rewards for providing liquidity.

## Core Concepts

### Annual Percentage Rate (APR)
Simple interest rate without compounding:
```
APR = (Rewards per Year / Principal) × 100%
```

### Annual Percentage Yield (APY)
Compound interest rate:
```
APY = (1 + APR/n)^n - 1
```
Where n = compounding frequency

**Example:**
```
12% APR compounded daily:
APY = (1 + 0.12/365)^365 - 1 = 12.75%
```

### Total Value Locked (TVL)
Total value of assets deposited in a protocol:
```
TVL = Σ(token_amount × token_price)
```

### Liquidity Provider (LP) Tokens
Tokens representing your share of a liquidity pool.

## Yield Sources

### 1. Trading Fees
Earned by providing liquidity to DEXs:
```
Fee APR = (Daily Volume × Fee %) × 365 / TVL
```

**Example:**
```
Pool: ETH/USDC on Uniswap
TVL: $10M
Daily Volume: $2M
Fee: 0.3%

Daily Fees = $2M × 0.003 = $6,000
Annual Fees = $6,000 × 365 = $2,190,000
APR = $2,190,000 / $10,000,000 = 21.9%
```

### 2. Lending Interest
Earned by supplying assets to lending protocols:
```
Supply APY = Borrow Rate × Utilization × (1 - Reserve Factor)
```

### 3. Token Rewards (Liquidity Mining)
Protocol tokens distributed to incentivize liquidity:
```
Token APR = (Tokens per Day × Token Price × 365) / TVL
```

**Example:**
```
Pool receives 1000 SUSHI/day
SUSHI price: $2
Pool TVL: $5M

Token APR = (1000 × $2 × 365) / $5,000,000 = 14.6%
```

### 4. Staking Rewards
Earned by staking protocol governance tokens:
```
Staking APY = (Rewards / Staked Amount) × 100%
```


### 5. Bribes and Vote Incentives
Protocols pay token holders to vote for their pools:
```
Bribe APR = (Bribe Value × 365) / (Voting Power × Token Price)
```

## Yield Farming Strategies

### 1. Single-Asset Staking

Simplest strategy: Stake one token to earn rewards.

**Example: Staking AAVE**
```
Stake: 100 AAVE @ $100 = $10,000
Rewards: 7% APY in AAVE
Annual Earnings: 7 AAVE = $700
```

**Pros:**
- No impermanent loss
- Simple
- Lower gas costs

**Cons:**
- Lower yields
- Single token exposure

### 2. Liquidity Provision

Provide liquidity to DEX pools to earn trading fees + rewards.

**Example: Uniswap V3 ETH/USDC**
```
Deposit: 10 ETH + $20,000 USDC
Fee Tier: 0.3%
Daily Volume: $50M
Your Share: 0.1%

Daily Fees = $50M × 0.003 × 0.001 = $150
Annual Fees = $150 × 365 = $54,750
APR = $54,750 / $40,000 = 136.9%

Plus: UNI token rewards
Minus: Impermanent loss risk
```

**Pros:**
- High yields
- Multiple revenue streams
- Protocol token rewards

**Cons:**
- Impermanent loss
- More complex
- Higher gas costs

### 3. Leveraged Yield Farming

Borrow assets to increase farming position.

**Example:**
```
1. Deposit 100 ETH ($200,000)
2. Borrow 150,000 USDC (75% LTV)
3. Buy 75 ETH with USDC
4. Deposit 75 ETH
5. Borrow 112,500 USDC
6. Repeat...

Final Position:
- 400 ETH exposure (4x leverage)
- 300,000 USDC debt
- Farming rewards on 400 ETH
```

**Risk Calculation:**
```
Liquidation Price = Debt / (Collateral × Liquidation Threshold)
= $300,000 / (400 ETH × 0.80)
= $937.50 per ETH

Current Price: $2,000
Buffer: 53% drop before liquidation
```

**Pros:**
- Amplified returns
- Capital efficiency

**Cons:**
- Liquidation risk
- Borrowing costs
- Complexity

### 4. Stablecoin Farming

Low-risk farming with stablecoins.

**Example: Curve 3pool**
```
Deposit: $100,000 (USDC/USDT/DAI)
Base APY: 2% (trading fees)
CRV Rewards: 5% APY
CVX Boost: 3% APY
Total APY: 10%

Annual Earnings: $10,000
Risk: Minimal (stablecoin depeg only)
```

**Pros:**
- Low volatility
- Predictable returns
- Lower impermanent loss

**Cons:**
- Lower yields than volatile pairs
- Still has smart contract risk

### 5. Auto-Compounding Vaults

Automated strategies that compound rewards.

**Example: Yearn Finance**
```
Deposit: 100 ETH in yvETH vault
Strategy: 
1. Stake ETH on Lido → stETH
2. Deposit stETH on Aave
3. Borrow ETH against stETH
4. Repeat (recursive leverage)
5. Auto-compound rewards

Manual: 12% APY
Auto-compound: 15.2% APY (daily compounding)
```

**Compounding Formula:**
```
APY = (1 + APR/n)^n - 1

Daily compounding (n=365):
APY = (1 + 0.12/365)^365 - 1 = 12.75%
```

**Pros:**
- Automated
- Gas-efficient
- Optimized strategies

**Cons:**
- Management fees (2%)
- Performance fees (20%)
- Less control

## Advanced Strategies

### 1. Delta-Neutral Farming

Eliminate price exposure while farming.

**Strategy:**
```
1. Deposit 100 ETH + $200,000 USDC in LP
2. Short 100 ETH on perpetual exchange
3. Earn LP fees + rewards
4. Hedge eliminates price risk

If ETH goes to $3,000:
- LP value increases $100,000
- Short loses $100,000
- Net: $0 price exposure
- Keep: LP fees + farming rewards
```

**Costs:**
- Funding rates on perpetual (0.01% - 0.1% daily)
- Gas fees for rebalancing

### 2. Basis Trading

Exploit price differences between spot and futures.

**Example:**
```
Spot ETH: $2,000
3-month Future: $2,100
Basis: 5% (20% annualized)

Strategy:
1. Buy spot ETH
2. Sell ETH future
3. Hold until expiry
4. Profit: $100 per ETH (5%)

Plus: Stake spot ETH for additional yield
Total APY: 20% + staking rewards
```

### 3. Liquidity Mining Rotation

Move capital to highest-yield opportunities.

**Example Weekly Rotation:**
```
Week 1: New protocol launch (500% APY)
Week 2: Rewards decrease (200% APY) → Move
Week 3: Find next high-yield opportunity
Week 4: Rotate again

Considerations:
- Gas costs
- Lock-up periods
- Token price volatility
- Rug pull risk
```

### 4. Governance Token Farming

Farm and immediately sell governance tokens.

**Strategy:**
```
1. Provide liquidity
2. Earn governance tokens (e.g., SUSHI)
3. Sell tokens immediately
4. Reinvest into LP

Avoids: Token price risk
Maximizes: Stable returns
```

**Alternative: Hold and Stake**
```
1. Farm governance tokens
2. Stake for additional rewards
3. Participate in governance
4. Earn protocol revenue share
```

## Risk Management

### 1. Impermanent Loss Calculation

**Formula:**
```
IL = 2√(price_ratio) / (1 + price_ratio) - 1
```

**Example:**
```
Initial: 10 ETH + $20,000 USDC (ETH = $2,000)
ETH doubles to $4,000

Without LP:
Value = 10 ETH × $4,000 + $20,000 = $60,000

With LP (constant product):
New ratio: √2 : 1
ETH amount: 10/√2 = 7.07 ETH
USDC amount: $20,000 × √2 = $28,284
Value = 7.07 × $4,000 + $28,284 = $56,568

IL = $56,568 / $60,000 - 1 = -5.7%
```

**Mitigation:**
- Choose correlated pairs (ETH/stETH)
- Use stablecoin pairs
- Ensure fees > IL
- Concentrated liquidity in narrow ranges

### 2. Smart Contract Risk

**Due Diligence:**
- Check audit reports
- Review code on Etherscan
- Assess team reputation
- Check TVL and age
- Monitor exploit history

**Risk Tiers:**
```
Low Risk: Aave, Compound, Uniswap (audited, battle-tested)
Medium Risk: Newer protocols with audits
High Risk: Unaudited, anonymous teams, new launches
```

### 3. Liquidation Risk

**Monitoring:**
```
Health Factor = (Collateral × Liquidation Threshold) / Debt

Safe: > 2.0
Caution: 1.5 - 2.0
Danger: 1.0 - 1.5
Liquidation: < 1.0
```

**Protection:**
- Maintain high health factor (>2.0)
- Set price alerts
- Use stop-losses
- Keep emergency funds for debt repayment

### 4. Rug Pull Risk

**Red Flags:**
- Anonymous team
- Unaudited contracts
- Centralized control
- Unrealistic APYs (>1000%)
- Low liquidity
- No time locks

**Protection:**
- Research team
- Check contract ownership
- Verify liquidity locks
- Start with small amounts
- Exit if suspicious

## Yield Optimization Tools

### 1. APY Aggregators

**Platforms:**
- DeFi Llama
- Vfat Tools
- APY.vision
- Zapper

**Features:**
- Compare yields across protocols
- Track portfolio performance
- Calculate real APY (including IL)
- Gas cost analysis

### 2. Auto-Compounding Vaults

**Yearn Finance:**
```
Strategies: 400+
TVL: $300M+
Fee: 2% management + 20% performance
```

**Beefy Finance:**
```
Chains: 20+
Vaults: 1000+
Fee: 0.5% - 4.5%
```

### 3. Yield Aggregators

**1inch:**
- Finds best swap routes
- Splits orders across DEXs
- Minimizes slippage

**Zapper:**
- One-click LP entry/exit
- Portfolio tracking
- Cross-protocol swaps

## Tax Considerations

### Taxable Events

1. **Swapping tokens:** Capital gains/loss
2. **Receiving rewards:** Ordinary income
3. **Selling rewards:** Capital gains/loss
4. **Providing liquidity:** Potentially taxable
5. **Impermanent loss:** May be deductible

### Record Keeping

Track:
- All transactions with timestamps
- Token prices at transaction time
- Gas fees paid
- Rewards received
- Impermanent loss

**Tools:**
- CoinTracker
- Koinly
- TokenTax
- CryptoTaxCalculator

## Yield Farming Metrics

### 1. Real Yield

Yield from actual revenue, not token emissions:
```
Real Yield = Protocol Revenue / TVL
```

**Example:**
```
GMX:
- Revenue: $50M/year (trading fees)
- TVL: $500M
- Real Yield: 10% APY
```

### 2. Dilution-Adjusted Yield

Accounts for token inflation:
```
Adjusted Yield = Nominal Yield - Token Inflation Rate
```

**Example:**
```
Nominal APY: 50%
Token Inflation: 40%
Real APY: 10%
```

### 3. Risk-Adjusted Return

Sharpe Ratio for DeFi:
```
Sharpe = (Return - Risk-Free Rate) / Volatility
```

## Code Example: Yield Farming Vault

```solidity
contract YieldVault {
    IERC20 public stakingToken;
    IERC20 public rewardToken;
    
    mapping(address => uint256) public balances;
    mapping(address => uint256) public rewardDebt;
    
    uint256 public totalStaked;
    uint256 public accRewardPerShare;
    uint256 public lastRewardBlock;
    uint256 public rewardPerBlock = 1e18; // 1 token per block
    
    function deposit(uint256 amount) external {
        updatePool();
        
        if (balances[msg.sender] > 0) {
            uint256 pending = (balances[msg.sender] * accRewardPerShare / 1e12) - rewardDebt[msg.sender];
            rewardToken.transfer(msg.sender, pending);
        }
        
        stakingToken.transferFrom(msg.sender, address(this), amount);
        balances[msg.sender] += amount;
        totalStaked += amount;
        rewardDebt[msg.sender] = balances[msg.sender] * accRewardPerShare / 1e12;
    }
    
    function withdraw(uint256 amount) external {
        updatePool();
        
        uint256 pending = (balances[msg.sender] * accRewardPerShare / 1e12) - rewardDebt[msg.sender];
        rewardToken.transfer(msg.sender, pending);
        
        balances[msg.sender] -= amount;
        totalStaked -= amount;
        stakingToken.transfer(msg.sender, amount);
        rewardDebt[msg.sender] = balances[msg.sender] * accRewardPerShare / 1e12;
    }
    
    function updatePool() internal {
        if (block.number <= lastRewardBlock) return;
        if (totalStaked == 0) {
            lastRewardBlock = block.number;
            return;
        }
        
        uint256 blocks = block.number - lastRewardBlock;
        uint256 reward = blocks * rewardPerBlock;
        accRewardPerShare += (reward * 1e12) / totalStaked;
        lastRewardBlock = block.number;
    }
    
    function pendingReward(address user) external view returns (uint256) {
        uint256 accReward = accRewardPerShare;
        if (block.number > lastRewardBlock && totalStaked > 0) {
            uint256 blocks = block.number - lastRewardBlock;
            uint256 reward = blocks * rewardPerBlock;
            accReward += (reward * 1e12) / totalStaked;
        }
        return (balances[user] * accReward / 1e12) - rewardDebt[user];
    }
}
```

## Conclusion

Yield farming offers opportunities for significant returns but requires understanding of complex mechanisms, careful risk management, and constant monitoring. Success comes from balancing yield potential against risks like impermanent loss, smart contract vulnerabilities, and market volatility.

---

*Next: Derivatives and Perpetual Futures*
